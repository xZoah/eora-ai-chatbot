# Архитектура EORA Chat Bot

## Обзор системы

EORA Chat Bot - это интеллектуальная система для консультаций клиентов, построенная на принципах RAG (Retrieval-Augmented Generation) с использованием OpenAI GPT-4o-mini.

## Компоненты системы

### 1. Data Layer (Слой данных)

#### 1.1 Web Scraper
- **Назначение**: Парсинг страниц сайта eora.ru
- **Технологии**: BeautifulSoup4, requests, aiohttp
- **Функции**:
  - Извлечение текстового контента
  - Структурирование данных о кейсах
  - Сохранение метаданных (URL, заголовки, даты)

#### 1.2 Vector Store (Pinecone)
- **Назначение**: Хранение и поиск эмбеддингов
- **Структура данных**:
  ```json
  {
    "id": "case_123",
    "text": "Полный текст кейса",
    "metadata": {
      "title": "Название кейса",
      "url": "https://eora.ru/cases/...",
      "category": "retail",
      "client": "Магнит"
    },
    "embedding": [0.1, 0.2, ...]
  }
  ```

#### 1.3 Database (PostgreSQL/Supabase)
- **Назначение**: Хранение пользовательских данных и сессий
- **Схема**:
  ```sql
  -- Пользователи
  users (
    id, telegram_id, username, created_at, 
    complexity_level, language
  )
  
  -- Сессии чата
  chat_sessions (
    id, user_id, started_at, last_activity
  )
  
  -- Сообщения
  messages (
    id, session_id, content, is_user, 
    created_at, response_time
  )
  
  -- Использованные источники
  message_sources (
    id, message_id, source_url, relevance_score
  )
  ```

### 2. AI Layer (Слой ИИ)

#### 2.1 LLM Service (OpenAI API)
- **Модель**: GPT-4o-mini
- **Функции**:
  - Генерация ответов на основе контекста
  - Поддержка разных уровней сложности
  - Форматирование ответов с ссылками

#### 2.2 Embedding Service
- **Модель**: text-embedding-3-small (OpenAI)
- **Функции**:
  - Создание эмбеддингов для текстов
  - Векторизация пользовательских запросов

#### 2.3 RAG Pipeline
```
Пользовательский запрос → Векторизация → Поиск в Pinecone → 
Контекст + Промпт → LLM → Ответ
```

### 3. Application Layer (Слой приложения)

#### 3.1 FastAPI Backend
- **Назначение**: REST API для интеграции
- **Эндпоинты**:
  ```
  POST /api/chat - Основной чат
  GET /api/health - Проверка здоровья
  POST /api/admin/update-data - Обновление данных
  ```

#### 3.2 Telegram Bot
- **Назначение**: Пользовательский интерфейс
- **Функции**:
  - Обработка сообщений
  - Управление настройками пользователя
  - Поддержка команд (/start, /help, /settings)

#### 3.3 Chat Service
- **Назначение**: Бизнес-логика чата
- **Функции**:
  - Управление контекстом диалога
  - Выбор уровня сложности
  - Кеширование частых запросов

### 4. Infrastructure Layer (Инфраструктура)

#### 4.1 Railway Deployment
- **Назначение**: Облачное развертывание
- **Конфигурация**:
  - Dockerfile для контейнеризации
  - Procfile для запуска
  - railway.json для настроек

#### 4.2 Redis Cache (Опционально)
- **Назначение**: Кеширование и сессии
- **Использование**:
  - Кеш частых запросов
  - Временное хранение контекста
  - Rate limiting

## Поток данных

### 1. Инициализация пользователя
```
Telegram → /start → Создание пользователя в БД → Приветствие
```

### 2. Обработка сообщения
```
Сообщение → Валидация → Поиск контекста → 
Векторный поиск → RAG → Генерация ответа → 
Сохранение в БД → Отправка пользователю
```

### 3. Обновление знаний
```
Новые данные → Парсинг → Создание эмбеддингов → 
Обновление Pinecone → Инвалидация кеша
```

## Технические решения

### Выбор LLM API

**OpenAI GPT-4o-mini** (используемый):
- ✅ Экономичный: ~$0.00015 за 1K токенов
- ✅ Высокое качество ответов
- ✅ Быстрая генерация
- ✅ Хорошая поддержка русского языка

### Векторное хранилище

**Pinecone** (используемый):
- ✅ Быстрый поиск
- ✅ Хорошая документация
- ✅ Интеграция с OpenAI
- ✅ Масштабируемость

### База данных

**PostgreSQL (Supabase)**:
- ✅ ACID транзакции
- ✅ JSON поддержка
- ✅ Хорошая производительность
- ✅ Бесплатный тариф

## Безопасность

### API ключи
- Хранение в переменных окружения
- Ротация ключей
- Мониторинг использования

### Валидация ввода
- Санитизация пользовательского ввода
- Rate limiting
- Защита от SQL injection

### Логирование
- Структурированные логи (Loguru)
- Мониторинг ошибок
- Аудит действий пользователей

## Масштабируемость

### Горизонтальное масштабирование
- Stateless архитектура
- Load balancing
- Микросервисная структура

### Вертикальное масштабирование
- Кеширование
- Оптимизация запросов
- Мониторинг производительности

## Мониторинг

### Метрики
- Время ответа
- Количество запросов
- Ошибки API
- Использование ресурсов

### Алерты
- Высокое время ответа
- Ошибки LLM API
- Проблемы с базой данных

## Развертывание

### Development
```bash
# Локальный запуск
python -m app.bot.telegram_bot
```

### Production (Railway)
```bash
# Автоматическое развертывание через Railway
# Настройка переменных окружения в Railway dashboard
```

### CI/CD
- GitHub Actions (планируется)
- Автоматические тесты
- Blue-green deployment 